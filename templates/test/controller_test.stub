<?php

namespace $NAMESPACE_CONTROLLERS_TESTS$;

use Illuminate\Http\Response;
use $NAMESPACE_MODEL$\$MODEL_NAME$;
use Illuminate\Foundation\Testing\RefreshDatabase;
use $NAMESPACE_TESTS$\TestCase;
use $NAMESPACE_TESTS$\ModelTestTrait;

class $MODEL_NAME$ControllerTest extends TestCase
{
    use ModelTestTrait;
    use RefreshDatabase;

    const BASE_PATH = '/$ROUTE_PREFIX$$MODEL_NAME_PLURAL_SNAKE$';
    const MODEL_MAIN_PROPERTY_KEY = 'name';

    public function setUp() : void
    {
        parent::setUp();
    }

    /**
     * @group $MODEL_NAME$
     */
    public function test_can_list_$MODEL_NAME_PLURAL_SNAKE$()
    {
        $response = $this->get(self::BASE_PATH);
        $response->assertStatus(Response::HTTP_OK);
    }

    /**
     * @group $MODEL_NAME$
     */
    public function test_can_create_$MODEL_NAME_CAMEL$()
    {
        $data = $MODEL_NAME$::factory()->make();
        $response = $this->post(self::BASE_PATH, $data->toArray());

        $response->assertSessionHasNoErrors();
        $response->assertStatus(Response::HTTP_FOUND);
        $response->assertRedirect(self::BASE_PATH);

        $this->assertDatabaseHas(
            $this->getModelTable(),
            [
                $this->getModelMainPropertyKey() => $data->{$this->getModelMainPropertyKey()},
            ]
        );
    }

    /**
     * @group $MODEL_NAME$
     */
    public function test_can_delete_$MODEL_NAME_CAMEL$()
    {
        $data = $MODEL_NAME$::factory()->create();
        $response = $this->post(
            self::BASE_PATH . '/' . $data->{$this->getModelPrimaryKey()}, 
            array_merge(['_method' => 'DELETE'])
        );
       
        $response->assertSessionHasNoErrors();
        $response->assertStatus(Response::HTTP_FOUND);
        $response->assertRedirect(self::BASE_PATH);
        $this->assertSoftDeleted($this->getModelTable(), [
            $this->getModelPrimaryKey() => $data->{$this->getModelPrimaryKey()}
        ]);
    }

    /**
     * @group $MODEL_NAME$
     */
    public function test_can_update_$MODEL_NAME_CAMEL$()
    {
        $data = $MODEL_NAME$::factory()->create();
        $updatedData = $MODEL_NAME$::factory()->make();

        $response = $this->post(
            self::BASE_PATH . '/' . $data->{$this->getModelPrimaryKey()}, 
            array_merge(['_method' => 'PATCH'], $updatedData->toArray())
        );
        
        $response->assertSessionHasNoErrors();
        $response->assertStatus(Response::HTTP_FOUND);
        $response->assertRedirect(self::BASE_PATH);

        $this->assertDatabaseHas(
            $this->getModelTable(),
            [
                $this->getModelPrimaryKey() => $data->{$this->getModelPrimaryKey()},
                $this->getModelMainPropertyKey() => $updatedData->{$this->getModelMainPropertyKey()},
            ]
        );
    }

    protected function getModelMainPropertyKey()
    {
        return self::MODEL_MAIN_PROPERTY_KEY;
    }
}